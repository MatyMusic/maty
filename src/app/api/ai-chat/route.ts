// src/app/api/ai-chat/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextRequest, NextResponse } from "next/server";

type Msg = { role: string; content: string };

function lastUserMessage(messages: Msg[]): string {
  if (!Array.isArray(messages)) return "";
  const last = [...messages].reverse().find((m) => m.role === "user");
  if (!last) return "";
  return String(last.content || "").trim();
}

/**
 * ×ž× ×•×¢ AI ×¤× ×™×ž×™ â€” ×’×¨×¡×” × ×§×™×™×” ×œ×œ× ×©×ž×•×ª, ×œ×œ× ×ž×§×•×ž×•×ª, ×œ×œ× ×§×‘×•×¦×•×ª.
 * ×›×•×ª×‘ ×¤×•×¡×˜×™× ×›×œ×œ×™×™×, ×¨×¢×™×•× ×•×ª, ×ª×™××•×¨×™× ×•×”××©×˜×’×™×.
 */
function buildSmartReply(raw: string): string {
  const text = raw.trim();
  if (!text) {
    return [
      "×‘×¨×•×š ×”×‘×! ðŸ˜Š",
      "×ª×›×ª×•×‘ ×›××Ÿ ×ž×” ××ª×” ×¨×•×¦×” ×©××›×™×Ÿ ×¢×‘×•×¨×š â€“ ×¤×•×¡×˜, ×¨×¢×™×•×Ÿ, ×ª×™××•×¨ ××• ×”××©×˜×’×™×.",
      "×× ×™ ×›×‘×¨ ××—×‘×¨ ×œ×š ×˜×§×¡×˜ ×ž×•×›×Ÿ ×©×ª×•×›×œ ×œ×”×©×ª×ž×© ×‘×• ×ž×™×“.",
    ].join("\n");
  }

  const lower = text.toLowerCase();

  // ×–×™×”×•×™ ×‘×§×©×” ×œ×ª×™××•×¨ / ×”××©×˜×’×™×
  const looksLikeTags =
    lower.includes("×”××©×˜×’") ||
    lower.includes("#") ||
    lower.includes("tags") ||
    lower.includes("×ª×™××•×¨");

  // ×–×™×”×•×™ ×‘×§×©×” ×œ×¨×¢×™×•× ×•×ª
  const looksLikeIdeas =
    lower.includes("×¨×¢×™×•×Ÿ") ||
    lower.includes("×¨×¢×™×•× ×•×ª") ||
    lower.includes("××ª×’×¨") ||
    lower.includes("×¤×¢×™×œ×•×ª") ||
    lower.includes("×ž×¡×™×‘×”") ||
    lower.includes("×©×™×—×”");

  // -------------------------------------------------------------
  // ðŸ”¹ ×”××©×˜×’×™× + ×ª×™××•×¨ â€” × ×§×™ ×•×©×§×˜
  // -------------------------------------------------------------
  if (looksLikeTags) {
    return [
      "×”××©×˜×’×™× ×ž×•×ž×œ×¦×™×:",
      "",
      "#Community #Friends #Vibes #Music #Lifestyle #Fun #Energy #Chat #GoodTimes",
      "",
      "×ª×™××•×¨ ×ž×•×ž×œ×¥:",
      "×™×© ×›××Ÿ ×ž×§×•× ×œ×©×ª×£ ×¨×’×¢×™× ××™×©×™×™×, ×ž×—×©×‘×•×ª, ×—×•×•×™×•×ª ×™×•×ž×™×•×ž×™×•×ª, ×ž×•×–×™×§×” ×•×¨×’×¢×™ ×”×©×¨××”. ×ž×•×–×ž× ×™× ×œ×”×’×™×‘, ×œ×¤×¨×’×Ÿ ×•×œ×¤×ª×•×— ×©×™×—×” ×˜×•×‘×” ðŸ˜Š",
    ].join("\n");
  }

  // -------------------------------------------------------------
  // ðŸ”¹ ×¨×¢×™×•× ×•×ª ×œ×¤×¢×™×œ×•×ª / ×¤×•×¡×˜ â€” ×œ×œ× ×©×ž×•×ª ×›×œ×œ
  // -------------------------------------------------------------
  if (looksLikeIdeas) {
    return [
      "×”× ×” ×›×ž×” ×¨×¢×™×•× ×•×ª ×˜×•×‘×™× ×©×ª×•×›×œ ×œ×¤×ª×•×— ××™×ª× ×©×™×—×”:",
      "",
      "1. ×œ×©×ª×£ ×¨×’×¢ ×ž×¦×—×™×§/×ž×¢×•×¨×¨ ×ž×—×©×‘×” ×ž×”×™×•× ×•×œ×©××•×œ ××—×¨×™× ×ž×” ×¢×‘×¨ ×¢×œ×™×”×.",
      "2. ×œ×‘×§×© ×”×ž×œ×¦×•×ª ×œ×ž×•×–×™×§×” ×©×ž×ª××™×ž×” ×œ××™×ž×•×Ÿ, × ×”×™×’×” ××• ×ž×¦×‘ ×¨×•×— ×˜×•×‘.",
      "3. ×œ×¤×ª×•×— ××ª×’×¨ ×©×‘×•×¢×™ ×§×˜×Ÿ â€” ×ž×©×”×• ×§×œ×™×œ ×©×× ×©×™× ×™×›×•×œ×™× ×œ×”×¦×˜×¨×£ ××œ×™×•.",
      "4. ×œ×©××•×œ ×¢×œ ×—×•×•×™×•×ª ×ž×—×’/××™×¨×•×¢/×ª×§×•×¤×” â€” ×‘×œ×™ ×©×ž×•×ª ×•×‘×œ×™ ××–×›×•×¨×™× ×¡×¤×¦×™×¤×™×™×.",
      "5. ×¤×•×¡×˜ ×”×©×¨××” ×§×¦×¨ â€“ ××™×š ×œ×”×™×©××¨ ×¢× ×× ×¨×’×™×” ×˜×•×‘×” ×’× ×‘×ª×§×•×¤×•×ª ×¢×ž×•×¡×•×ª.",
      "",
      "×ª×¨×’×™×© ×—×•×¤×©×™ ×œ×‘×—×•×¨ ××—×“ ×•×œ×”×¤×•×š ××•×ª×• ×œ×¤×•×¡×˜ ×ž×©×œ×š.",
    ].join("\n");
  }

  // -------------------------------------------------------------
  // ðŸ”¹ ×¤×•×¡×˜ ×›×œ×œ×™ ×œÖ¾CLUB â€” × ×§×™ ×œ×—×œ×•×˜×™×Ÿ ×ž×©×ž×•×ª
  // -------------------------------------------------------------
  return [
    "×¤×•×¡×˜ ×ž×•×›×Ÿ ×œ×©×™×ž×•×©:",
    "",
    "â€” â€” â€”",
    "×¨×¦×™×ª×™ ×œ×©×ª×£ ×¨×’×¢ ×§×˜×Ÿ ×ž×”×™×•× ×©×’×¨× ×œ×™ ×œ×¢×¦×•×¨ ×•×œ×”×’×™×“: ×—×™×™×‘ ×œ×›×ª×•×‘ ×¢×œ ×–×” ðŸ˜Š",
    "",
    text ? `×ž×” ×©×”×™×” ×œ×™ ×‘×¨××©: ${text}` : "",
    "",
    "×× ×–×” ×ž×ª×—×‘×¨ ×’× ×œ×›× â€“ ××©×ž×— ×œ×©×ž×•×¢ ××™×š ×¢×‘×¨ ×”×™×•× ×©×œ×›×, ×ž×” × ×ª×Ÿ ×œ×›× ×›×•×—, ××• ××™×–×” ×©×™×¨ ×œ×™×•×•×” ××ª×›×.",
    "",
    "×ž×™ ×ž×¦×˜×¨×£ ×œ×©×™×—×”? ðŸ‘‡",
    "â€” â€” â€”",
  ]
    .filter(Boolean)
    .join("\n");
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json().catch(() => ({}));
    const messages = Array.isArray(body?.messages) ? body.messages : [];
    const raw = lastUserMessage(messages);

    const reply = buildSmartReply(raw);

    return NextResponse.json(
      {
        ok: true,
        reply,
        engine: "local-smart-ai",
      },
      { status: 200 },
    );
  } catch (e: any) {
    console.error("[local-ai-chat] error:", e);
    return NextResponse.json(
      {
        ok: false,
        reply: "×”×™×™×ª×” ×ª×§×œ×” ×¨×’×¢×™×ª ×‘×ž×¢×¨×›×ª. × ×¡×” ×©×•×‘.",
        error: e?.message || "unknown_error",
      },
      { status: 200 },
    );
  }
}
